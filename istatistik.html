<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Raporlar | SAATÜRN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    
    <script>
        // Oturum Kontrolü
        if(localStorage.getItem("saaturn_session") !== "active") {
            window.location.href = "admin-login.html";
        }
    </script>

    <style>
        body { background-color: #000; color: #fff; font-family: 'Montserrat', sans-serif; }
        .navbar { background-color: #050505 !important; border-bottom: 1px solid #222; }
        
        /* Kartlar */
        .stat-card { background: #111; border: 1px solid #222; padding: 20px; border-radius: 12px; height: 100%; }
        .stat-title { color: #888; font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #fff; margin: 10px 0; }
        .text-gold { color: #D4AF37 !important; }

        /* Grafik Kutusu */
        .chart-box { background: #111; border: 1px solid #222; padding: 25px; border-radius: 12px; height: 100%; }
        
        /* Tablo */
        .table-dark { --bs-table-bg: #111; margin-bottom: 0; }
        .table-dark th { color: #D4AF37; font-weight: normal; border-bottom: 1px solid #333; }
        .table-dark td { border-bottom: 1px solid #222; color: #ccc; }

        
    </style>
</head>
<body onload="verileriAnalizEt()">

    <nav class="navbar navbar-dark px-4 py-3">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <span data-feather="pie-chart" class="text-warning me-2"></span>
                <span class="navbar-brand text-warning fw-bold m-0">FİNANSAL ANALİZ</span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <span class="text-secondary small d-none d-md-block">Son Güncelleme: <span id="lastUpdate">...</span></span>
                <a href="admin-panel.html" class="btn btn-sm btn-outline-warning rounded-pill px-4">PANELE DÖN</a>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-title">GERÇEKLEŞEN CİRO</div>
                    <div class="stat-value text-gold" id="liveCiro">0 ₺</div>
                    <small class="text-success">Tahsil Edilen Tutar</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-title">TOPLAM SİPARİŞ</div>
                    <div class="stat-value" id="liveSiparis">0</div>
                    <small class="text-secondary" id="liveBekleyen">Hesaplanıyor...</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-title">ORTALAMA SEPET</div>
                    <div class="stat-value" id="liveOrtalama">0 ₺</div>
                    <small class="text-muted">Tamamlanan Sipariş Başına</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-title">TREND ÜRÜN</div>
                    <div class="stat-value" style="font-size:1.2rem; margin-top:18px;" id="liveTrend">Veri Yok</div>
                    <small class="text-warning">En Çok Tercih Edilen</small>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="chart-box">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="m-0 text-white">Gelir Akışı (Son 6 Ay)</h5>
                        <small class="text-secondary">Sadece Tamamlanan Satışlar</small>
                    </div>
                    <canvas id="mainChart" height="100"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-box">
                    <h5 class="mb-4 text-white">Kategori Dağılımı</h5>
                    <div style="height: 250px; position: relative;">
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div class="text-center mt-3 small text-secondary">
                        Tüm siparişlerin kategori bazlı analizi
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="chart-box p-0 overflow-hidden">
                    <div class="p-3 border-bottom border-secondary bg-dark d-flex justify-content-between">
                        <h6 class="mb-0 text-white">Son Finansal Hareketler</h6>
                        <button class="btn btn-sm btn-link text-warning text-decoration-none p-0" onclick="location.reload()">Yenile</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th class="ps-4">SİPARİŞ NO</th>
                                    <th>MÜŞTERİ</th>
                                    <th>ÜRÜN DETAYI</th>
                                    <th>TUTAR / DURUM</th>
                                    <th>TARİH</th>
                                </tr>
                            </thead>
                            <tbody id="liveTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

       

    </div>

    <script>
        feather.replace();
        
        // Chart.js Global Renk Ayarları
        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = '#333';
        
        let chartInstance = null;
        let pieInstance = null;

        function verileriAnalizEt() {
            // Tarihi Güncelle
            document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString('tr-TR');

            // LocalStorage'dan Siparişleri Çek
            const siparisler = JSON.parse(localStorage.getItem("saaturnSiparisleri")) || [];
            
            let toplamCiro = 0;
            let bekleyenSayisi = 0;
            let tamamlananSayisi = 0;
            let katSayaci = { 'Lüks': 0, 'Spor': 0, 'Klasik': 0, 'Özel': 0 };
            let urunSayaci = {};
            
            // Tabloyu Temizle
            const tablo = document.getElementById("liveTableBody");
            tablo.innerHTML = "";

            if(siparisler.length === 0) {
                tablo.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Henüz veri girişi yapılmamış.</td></tr>';
            }

            // --- 1. VERİ ANALİZİ DÖNGÜSÜ ---
            [...siparisler].reverse().forEach(s => {
                // Fiyatı Sayıya Çevir
                let fiyat = 0;
                if(s.fiyat) {
                    fiyat = parseInt(s.fiyat.toString().replace(/\./g, '').replace(' ₺', ''));
                }

                // *** KRİTİK AYRIM: KARGOLANDI MI? ***
                if(s.durum === "Kargolandı") {
                    toplamCiro += fiyat;
                    tamamlananSayisi++;
                } else {
                    bekleyenSayisi++;
                }

                // Kategori Bulma (Tüm siparişler üzerinden analiz yapılır)
                let u = s.urun.toUpperCase();
                if(u.includes("ELITE") || u.includes("PRESTIGE") || u.includes("TITAN")) katSayaci['Lüks']++;
                else if(u.includes("OCEAN")) katSayaci['Spor']++;
                else if(u.includes("TIMELESS")) katSayaci['Klasik']++;
                else katSayaci['Özel']++;

                // Trend Ürün Hesabı
                let saltAd = u.split('(')[0].trim();
                urunSayaci[saltAd] = (urunSayaci[saltAd] || 0) + 1;

                // Tabloya Ekle (Son 10 işlem)
                if(tablo.rows.length < 10) {
                    let durumIkon = s.durum === "Kargolandı" 
                        ? '<span class="badge bg-success" style="font-size:0.6rem">✓</span>' 
                        : '<span class="badge bg-warning text-dark" style="font-size:0.6rem">⏳</span>';
                    
                    let fiyatClass = s.durum === "Kargolandı" ? "text-warning fw-bold" : "text-secondary text-decoration-line-through";

                    tablo.innerHTML += `
                        <tr>
                            <td class="ps-4 text-secondary">#${s.id}</td>
                            <td>${s.ad}</td>
                            <td>${s.urun}</td>
                            <td><span class="${fiyatClass}">${s.fiyat}</span> ${durumIkon}</td>
                            <td>${s.tarih}</td>
                        </tr>`;
                }
            });

            // --- 2. KARTLARI GÜNCELLE ---
            document.getElementById("liveCiro").innerText = toplamCiro.toLocaleString('tr-TR') + " ₺";
            document.getElementById("liveSiparis").innerText = siparisler.length;
            document.getElementById("liveBekleyen").innerText = `(${bekleyenSayisi} Bekleyen / ${tamamlananSayisi} Tamamlanan)`;
            
            // Ortalama sadece tamamlananlar üzerinden
            let ortalama = tamamlananSayisi > 0 ? Math.floor(toplamCiro/tamamlananSayisi) : 0;
            document.getElementById("liveOrtalama").innerText = ortalama.toLocaleString('tr-TR') + " ₺";

            // En Çok Satanı Bul
            let trend = Object.keys(urunSayaci).length > 0 ? Object.keys(urunSayaci).reduce((a, b) => urunSayaci[a] > urunSayaci[b] ? a : b) : "Veri Yok";
            trend = trend.replace("SATÜRN ", "");
            document.getElementById("liveTrend").innerText = trend;

            // --- 3. GRAFİKLERİ ÇİZ ---
            cizGrafikler(siparisler, katSayaci);
        }

        function cizGrafikler(siparisler, kat) {
            // Chartları resetle (Tekrar çizim hatasını önlemek için)
            if(chartInstance) chartInstance.destroy();
            if(pieInstance) pieInstance.destroy();

            // AYLIK CİRO HESAPLAMA (Son 6 Ay) - Sadece Kargolananlar!
            const aylar = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            const simdi = new Date();
            let labels = [];
            let dataPoints = [0, 0, 0, 0, 0, 0];

            for (let i = 5; i >= 0; i--) {
                let d = new Date(simdi.getFullYear(), simdi.getMonth() - i, 1);
                labels.push(aylar[d.getMonth()]);
            }

            siparisler.forEach(s => {
                if(s.durum === "Kargolandı") {
                    let parts = s.tarih.split('.');
                    let sAy = parseInt(parts[1]) - 1; 
                    let sYil = parseInt(parts[2]);
                    let fiyat = parseInt(s.fiyat.replace(/\./g, '').replace(' ₺', ''));

                    let farkAy = (simdi.getMonth() - sAy + (simdi.getFullYear() - sYil) * 12);
                    if (farkAy >= 0 && farkAy < 6) {
                        dataPoints[5 - farkAy] += fiyat;
                    }
                }
            });

            // 1. ÇİZGİ GRAFİK (CİRO)
            const ctxLine = document.getElementById('mainChart').getContext('2d');
            const gradient = ctxLine.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(212, 175, 55, 0.5)');
            gradient.addColorStop(1, 'rgba(212, 175, 55, 0.0)');

            chartInstance = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gerçekleşen Ciro (₺)',
                        data: dataPoints,
                        borderColor: '#D4AF37',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#D4AF37',
                        pointRadius: 5
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#222' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // 2. PASTA GRAFİK (KATEGORİ)
            let pieData = [kat['Lüks'], kat['Spor'], kat['Klasik'], kat['Özel']];
            if(pieData.reduce((a,b)=>a+b, 0) === 0) pieData = [0, 0, 0, 0];

            pieInstance = new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Lüks', 'Spor', 'Klasik', 'Özel'],
                    datasets: [{
                        data: pieData,
                        backgroundColor: ['#D4AF37', '#F8E49E', '#555', '#fff'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    cutout: '75%', 
                    plugins: { 
                        legend: { position: 'right', labels: { color: '#ccc', boxWidth: 10 } } 
                    } 
                }
            });
        }
    </script>
</body>
</html>